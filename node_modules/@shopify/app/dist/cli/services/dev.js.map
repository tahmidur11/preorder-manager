{"version":3,"file":"dev.js","sourceRoot":"","sources":["../../../src/cli/services/dev.ts"],"names":[],"mappings":"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","sourcesContent":["import {ensureDevEnvironment} from './environment.js'\nimport {generateFrontendURL, generatePartnersURLs, getURLs, shouldOrPromptUpdateURLs, updateURLs} from './dev/urls.js'\nimport {installAppDependencies} from './dependencies.js'\nimport {devUIExtensions} from './dev/extension.js'\nimport {outputAppURL, outputExtensionsMessages, outputUpdateURLsResult} from './dev/output.js'\nimport {themeExtensionArgs} from './dev/theme-extension-args.js'\nimport {fetchSpecifications} from './generate/fetch-extension-specifications.js'\nimport {\n  ReverseHTTPProxyTarget,\n  runConcurrentHTTPProcessesAndPathForwardTraffic,\n} from '../utilities/app/http-reverse-proxy.js'\nimport {AppInterface, AppConfiguration, Web, WebType} from '../models/app/app.js'\nimport metadata from '../metadata.js'\nimport {UIExtension} from '../models/app/extensions.js'\nimport {fetchProductVariant} from '../utilities/extensions/fetch-product-variant.js'\nimport {load} from '../models/app/loader.js'\nimport {getAppIdentifiers} from '../models/app/identifiers.js'\nimport {getAnalyticsTunnelType} from '../utilities/analytics.js'\nimport {output} from '@shopify/cli-kit'\nimport {Config} from '@oclif/core'\nimport {reportAnalyticsEvent} from '@shopify/cli-kit/node/analytics'\nimport {execCLI2} from '@shopify/cli-kit/node/ruby'\nimport {renderConcurrent} from '@shopify/cli-kit/node/ui'\nimport {getAvailableTCPPort} from '@shopify/cli-kit/node/tcp'\nimport {AbortSignal} from '@shopify/cli-kit/node/abort'\nimport {hashString} from '@shopify/cli-kit/node/crypto'\nimport {exec} from '@shopify/cli-kit/node/system'\nimport {isSpinEnvironment, spinFqdn} from '@shopify/cli-kit/node/environment/spin'\nimport {\n  AdminSession,\n  ensureAuthenticatedAdmin,\n  ensureAuthenticatedPartners,\n  ensureAuthenticatedStorefront,\n} from '@shopify/cli-kit/node/session'\nimport {Writable} from 'stream'\n\nexport interface DevOptions {\n  directory: string\n  id?: number\n  apiKey?: string\n  storeFqdn?: string\n  reset: boolean\n  update: boolean\n  commandConfig: Config\n  skipDependenciesInstallation: boolean\n  subscriptionProductUrl?: string\n  checkoutCartUrl?: string\n  tunnelUrl?: string\n  tunnel: boolean\n  noTunnel: boolean\n  theme?: string\n  themeExtensionPort?: number\n}\n\ninterface DevWebOptions {\n  backendPort: number\n  apiKey: string\n  apiSecret?: string\n  hostname?: string\n  scopes?: AppConfiguration['scopes']\n}\n\nasync function dev(options: DevOptions) {\n  const token = await ensureAuthenticatedPartners()\n  const {storeFqdn, remoteApp, updateURLs: cachedUpdateURLs, tunnelPlugin} = await ensureDevEnvironment(options, token)\n\n  const apiKey = remoteApp.apiKey\n  const specifications = await fetchSpecifications({token, apiKey, config: options.commandConfig})\n  let localApp = await load({directory: options.directory, specifications})\n\n  if (!options.skipDependenciesInstallation) {\n    localApp = await installAppDependencies(localApp)\n  }\n\n  const {frontendUrl, frontendPort, usingLocalhost} = await generateFrontendURL({\n    ...options,\n    app: localApp,\n    cachedTunnelPlugin: tunnelPlugin,\n  })\n\n  const backendPort = await getAvailableTCPPort()\n\n  const frontendConfig = localApp.webs.find(({configuration}) => configuration.type === WebType.Frontend)\n  const backendConfig = localApp.webs.find(({configuration}) => configuration.type === WebType.Backend)\n\n  /** If the app doesn't have web/ the link message is not necessary */\n  const exposedUrl = usingLocalhost ? `${frontendUrl}:${frontendPort}` : frontendUrl\n  let shouldUpdateURLs = false\n  if ((frontendConfig || backendConfig) && options.update) {\n    const currentURLs = await getURLs(apiKey, token)\n    const newURLs = generatePartnersURLs(exposedUrl, backendConfig?.configuration.authCallbackPath)\n    shouldUpdateURLs = await shouldOrPromptUpdateURLs({\n      currentURLs,\n      appDirectory: localApp.directory,\n      cachedUpdateURLs,\n      newApp: remoteApp.newApp,\n    })\n    if (shouldUpdateURLs) await updateURLs(newURLs, apiKey, token)\n    await outputUpdateURLsResult(shouldUpdateURLs, newURLs, remoteApp)\n    outputAppURL(storeFqdn, exposedUrl)\n  }\n\n  // If we have a real UUID for an extension, use that instead of a random one\n  const prodEnvIdentifiers = await getAppIdentifiers({app: localApp})\n  const envExtensionsIds = prodEnvIdentifiers.extensions || {}\n  const extensionsIds = prodEnvIdentifiers.app === apiKey ? envExtensionsIds : {}\n  localApp.extensions.ui.forEach((ext) => (ext.devUUID = extensionsIds[ext.localIdentifier] ?? ext.devUUID))\n\n  const backendOptions = {\n    apiKey,\n    backendPort,\n    scopes: localApp.configuration.scopes,\n    apiSecret: (remoteApp.apiSecret as string) ?? '',\n    hostname: exposedUrl,\n  }\n\n  const proxyTargets: ReverseHTTPProxyTarget[] = []\n  const proxyPort = usingLocalhost ? await getAvailableTCPPort() : frontendPort\n  const proxyUrl = usingLocalhost ? `${frontendUrl}:${proxyPort}` : frontendUrl\n\n  if (localApp.extensions.ui.length > 0) {\n    const devExt = await devUIExtensionsTarget({\n      app: localApp,\n      id: remoteApp.id,\n      apiKey,\n      url: proxyUrl,\n      storeFqdn,\n      grantedScopes: remoteApp.grantedScopes,\n      subscriptionProductUrl: options.subscriptionProductUrl,\n      checkoutCartUrl: options.checkoutCartUrl,\n    })\n    proxyTargets.push(devExt)\n  }\n\n  outputExtensionsMessages(localApp, storeFqdn, proxyUrl)\n\n  const additionalProcesses: output.OutputProcess[] = []\n\n  if (localApp.extensions.theme.length > 0) {\n    const adminSession = await ensureAuthenticatedAdmin(storeFqdn)\n    const storefrontToken = await ensureAuthenticatedStorefront()\n    const extension = localApp.extensions.theme[0]!\n    const args = await themeExtensionArgs(extension, apiKey, token, options)\n    const devExt = await devThemeExtensionTarget(args, adminSession, storefrontToken, token)\n    additionalProcesses.push(devExt)\n  }\n\n  if (backendConfig) {\n    additionalProcesses.push(await devBackendTarget(backendConfig, backendOptions))\n  }\n\n  if (frontendConfig) {\n    const frontendOptions: DevFrontendTargetOptions = {\n      web: frontendConfig,\n      apiKey,\n      scopes: localApp.configuration.scopes,\n      apiSecret: (remoteApp.apiSecret as string) ?? '',\n      hostname: frontendUrl,\n      backendPort,\n    }\n\n    if (usingLocalhost) {\n      additionalProcesses.push(await devFrontendNonProxyTarget(frontendOptions, frontendPort))\n    } else {\n      proxyTargets.push(await devFrontendProxyTarget(frontendOptions))\n    }\n  }\n\n  await logMetadataForDev({devOptions: options, tunnelUrl: frontendUrl, shouldUpdateURLs, storeFqdn})\n\n  await reportAnalyticsEvent({config: options.commandConfig})\n\n  if (proxyTargets.length === 0) {\n    await renderConcurrent({processes: additionalProcesses})\n  } else {\n    await runConcurrentHTTPProcessesAndPathForwardTraffic(proxyPort, proxyTargets, additionalProcesses)\n  }\n}\n\ninterface DevFrontendTargetOptions extends DevWebOptions {\n  web: Web\n  backendPort: number\n}\n\nasync function devFrontendNonProxyTarget(\n  options: DevFrontendTargetOptions,\n  port: number,\n): Promise<output.OutputProcess> {\n  const devFrontend = await devFrontendProxyTarget(options)\n  return {\n    prefix: devFrontend.logPrefix,\n    action: async (stdout: Writable, stderr: Writable, signal: AbortSignal) => {\n      await devFrontend.action(stdout, stderr, signal, port)\n    },\n  }\n}\n\nfunction devThemeExtensionTarget(\n  args: string[],\n  adminSession: AdminSession,\n  storefrontToken: string,\n  token: string,\n): output.OutputProcess {\n  return {\n    prefix: 'extensions',\n    action: async (_stdout: Writable, _stderr: Writable, _signal: AbortSignal) => {\n      await execCLI2(['extension', 'serve', ...args], {adminSession, storefrontToken, token})\n    },\n  }\n}\n\nasync function devFrontendProxyTarget(options: DevFrontendTargetOptions): Promise<ReverseHTTPProxyTarget> {\n  const {commands} = options.web.configuration\n  const [cmd, ...args] = commands.dev.split(' ')\n\n  return {\n    logPrefix: options.web.configuration.type,\n    action: async (stdout: Writable, stderr: Writable, signal: AbortSignal, port: number) => {\n      await exec(cmd!, args, {\n        cwd: options.web.directory,\n        stdout,\n        stderr,\n        env: {\n          ...(await getDevEnvironmentVariables(options)),\n          BACKEND_PORT: `${options.backendPort}`,\n          PORT: `${port}`,\n          FRONTEND_PORT: `${port}`,\n          APP_URL: options.hostname,\n          APP_ENV: 'development',\n          // Note: These are Laravel varaibles for backwards compatibility with 2.0 templates.\n          SERVER_PORT: `${port}`,\n        },\n        signal,\n      })\n    },\n  }\n}\n\nasync function getDevEnvironmentVariables(options: DevWebOptions) {\n  return {\n    ...process.env,\n    SHOPIFY_API_KEY: options.apiKey,\n    SHOPIFY_API_SECRET: options.apiSecret,\n    HOST: options.hostname,\n    SCOPES: options.scopes,\n    NODE_ENV: `development`,\n    ...(isSpinEnvironment() && {\n      SHOP_CUSTOM_DOMAIN: `shopify.${await spinFqdn()}`,\n    }),\n  }\n}\n\nasync function devBackendTarget(web: Web, options: DevWebOptions): Promise<output.OutputProcess> {\n  const {commands} = web.configuration\n  const [cmd, ...args] = commands.dev.split(' ')\n  const env = {\n    ...(await getDevEnvironmentVariables(options)),\n    // SERVER_PORT is the convention Artisan uses\n    PORT: `${options.backendPort}`,\n    SERVER_PORT: `${options.backendPort}`,\n    BACKEND_PORT: `${options.backendPort}`,\n  }\n\n  return {\n    prefix: web.configuration.type,\n    action: async (stdout: Writable, stderr: Writable, signal: AbortSignal) => {\n      await exec(cmd!, args, {\n        cwd: web.directory,\n        stdout,\n        stderr,\n        signal,\n        env: {\n          ...process.env,\n          ...env,\n        },\n      })\n    },\n  }\n}\n\ninterface DevUIExtensionsTargetOptions {\n  app: AppInterface\n  apiKey: string\n  url: string\n  storeFqdn: string\n  grantedScopes: string[]\n  id?: string\n  subscriptionProductUrl?: string\n  checkoutCartUrl?: string\n}\n\nasync function devUIExtensionsTarget({\n  app,\n  apiKey,\n  id,\n  url,\n  storeFqdn,\n  grantedScopes,\n  subscriptionProductUrl,\n  checkoutCartUrl,\n}: DevUIExtensionsTargetOptions): Promise<ReverseHTTPProxyTarget> {\n  const cartUrl = await buildCartURLIfNeeded(app.extensions.ui, storeFqdn, checkoutCartUrl)\n  return {\n    logPrefix: 'extensions',\n    pathPrefix: '/extensions',\n    action: async (stdout: Writable, stderr: Writable, signal: AbortSignal, port: number) => {\n      await devUIExtensions({\n        app,\n        id,\n        extensions: app.extensions.ui,\n        stdout,\n        stderr,\n        signal,\n        url,\n        port,\n        storeFqdn,\n        apiKey,\n        grantedScopes,\n        checkoutCartUrl: cartUrl,\n        subscriptionProductUrl,\n      })\n    },\n  }\n}\n\n/**\n * To prepare Checkout UI Extensions for dev'ing we need to retrieve a valid product variant ID\n * @param extensions - The UI Extensions to dev\n * @param store - The store FQDN\n */\nasync function buildCartURLIfNeeded(extensions: UIExtension[], store: string, checkoutCartUrl?: string) {\n  const hasUIExtension = extensions.map((ext) => ext.type).includes('checkout_ui_extension')\n  if (!hasUIExtension) return undefined\n  if (checkoutCartUrl) return checkoutCartUrl\n  const variantId = await fetchProductVariant(store)\n  return `/cart/${variantId}:1`\n}\n\nasync function logMetadataForDev(options: {\n  devOptions: DevOptions\n  tunnelUrl: string\n  shouldUpdateURLs: boolean\n  storeFqdn: string\n}) {\n  const tunnelType = await getAnalyticsTunnelType(options.devOptions.commandConfig, options.tunnelUrl)\n  await metadata.addPublicMetadata(() => ({\n    cmd_dev_tunnel_type: tunnelType,\n    cmd_dev_tunnel_custom_hash: tunnelType === 'custom' ? hashString(options.tunnelUrl) : undefined,\n    cmd_dev_urls_updated: options.shouldUpdateURLs,\n    store_fqdn_hash: hashString(options.storeFqdn),\n    cmd_app_dependency_installation_skipped: options.devOptions.skipDependenciesInstallation,\n    cmd_app_reset_used: options.devOptions.reset,\n  }))\n\n  await metadata.addSensitiveMetadata(() => ({\n    store_fqdn: options.storeFqdn,\n    cmd_dev_tunnel_custom: tunnelType === 'custom' ? options.tunnelUrl : undefined,\n  }))\n}\n\nexport default dev\n"]}