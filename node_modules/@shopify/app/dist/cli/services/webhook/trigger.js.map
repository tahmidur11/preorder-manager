{"version":3,"file":"trigger.js","sourceRoot":"","sources":["../../../../src/cli/services/webhook/trigger.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,eAAe,EAAC,MAAM,sBAAsB,CAAA;AACpD,OAAO,EAAC,gBAAgB,EAAa,MAAM,qBAAqB,CAAA;AAChE,OAAO,EAAC,mBAAmB,EAAC,MAAM,4BAA4B,CAAA;AAC9D,OAAO,EAAC,kBAAkB,EAAC,MAAM,2BAA2B,CAAA;AAC5D,OAAO,EAAC,aAAa,EAAC,MAAM,qBAAqB,CAAA;AACjD,OAAO,EACL,uBAAuB,EACvB,iBAAiB,EACjB,aAAa,EACb,YAAY,GAEb,MAAM,yCAAyC,CAAA;AAChD,OAAO,EAAC,MAAM,EAAC,MAAM,kBAAkB,CAAA;AACvC,OAAO,EAAC,2BAA2B,EAAC,MAAM,+BAA+B,CAAA;AAEzE;;;;;GAKG;AACH,MAAM,CAAC,KAAK,UAAU,qBAAqB,CAAC,KAA0B;IACpE,MAAM,KAAK,GAAG,MAAM,2BAA2B,EAAE,CAAA;IAEjD,MAAM,UAAU,GAAG,MAAM,iBAAiB,CAAC,KAAK,CAAC,UAAU,EAAE,MAAM,kBAAkB,CAAC,KAAK,CAAC,CAAC,CAAA;IAC7F,MAAM,KAAK,GAAG,MAAM,YAAY,CAAC,KAAK,CAAC,KAAK,EAAE,UAAU,EAAE,MAAM,aAAa,CAAC,KAAK,EAAE,UAAU,CAAC,CAAC,CAAA;IAEjG,MAAM,CAAC,cAAc,EAAE,OAAO,CAAC,GAAG,MAAM,uBAAuB,CAAC,KAAK,CAAC,cAAc,EAAE,KAAK,CAAC,OAAO,CAAC,CAAA;IAEpG,MAAM,YAAY,GAAG,MAAM,aAAa,CAAC,KAAK,CAAC,YAAY,CAAC,CAAA;IAE5D,MAAM,MAAM,GAAG,MAAM,gBAAgB,CAAC,KAAK,EAAE,KAAK,EAAE,UAAU,EAAE,cAAc,EAAE,OAAO,EAAE,YAAY,CAAC,CAAA;IAEtG,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE;QACnB,MAAM,MAAM,CAAC,YAAY,CAAC,oBAAoB,YAAY,CAAC,MAAM,CAAC,UAAU,CAAC,EAAE,CAAC,CAAA;QAChF,OAAM;KACP;IAED,IAAI,cAAc,KAAK,eAAe,CAAC,SAAS,EAAE;QAChD,MAAM,MAAM,GAAG,MAAM,mBAAmB,CAAC,OAAO,EAAE,MAAM,CAAC,aAAa,EAAE,MAAM,CAAC,OAAO,CAAC,CAAA;QAEvF,IAAI,MAAM,EAAE;YACV,MAAM,CAAC,OAAO,CAAC,8BAA8B,CAAC,CAAA;YAC9C,OAAM;SACP;QAED,MAAM,MAAM,CAAC,YAAY,CAAC,2BAA2B,CAAC,CAAA;QACtD,OAAM;KACP;IAED,IAAI,MAAM,CAAC,aAAa,KAAK,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,EAAE;QAC/C,MAAM,CAAC,OAAO,CAAC,wCAAwC,CAAC,CAAA;KACzD;AACH,CAAC;AAED,SAAS,YAAY,CAAC,MAAoB;IACxC,IAAI;QACF,OAAO,MAAM;aACV,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CACf,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC;aACxB,GAAG,CAAC,CAAC,GAAW,EAAE,EAAE,CAAC,OAAO,GAAG,EAAE,CAAC;aAClC,IAAI,CAAC,IAAI,CAAC,CACd;aACA,IAAI,CAAC,IAAI,CAAC,CAAA;QACb,qDAAqD;KACtD;IAAC,OAAO,GAAG,EAAE;QACZ,OAAO,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAA;KAC9B;AACH,CAAC","sourcesContent":["import {DELIVERY_METHOD} from './trigger-options.js'\nimport {getWebhookSample, UserErrors} from './request-sample.js'\nimport {triggerLocalWebhook} from './trigger-local-webhook.js'\nimport {requestApiVersions} from './request-api-versions.js'\nimport {requestTopics} from './request-topics.js'\nimport {\n  collectAddressAndMethod,\n  collectApiVersion,\n  collectSecret,\n  collectTopic,\n  WebhookTriggerFlags,\n} from '../../prompts/webhook/options-prompt.js'\nimport {output} from '@shopify/cli-kit'\nimport {ensureAuthenticatedPartners} from '@shopify/cli-kit/node/session'\n\n/**\n * Orchestrates the command request by requesting the sample and sending it to localhost if required.\n * It outputs the result in console\n *\n * @param flags - Passed flags\n */\nexport async function webhookTriggerService(flags: WebhookTriggerFlags) {\n  const token = await ensureAuthenticatedPartners()\n\n  const apiVersion = await collectApiVersion(flags.apiVersion, await requestApiVersions(token))\n  const topic = await collectTopic(flags.topic, apiVersion, await requestTopics(token, apiVersion))\n\n  const [deliveryMethod, address] = await collectAddressAndMethod(flags.deliveryMethod, flags.address)\n\n  const sharedSecret = await collectSecret(flags.sharedSecret)\n\n  const sample = await getWebhookSample(token, topic, apiVersion, deliveryMethod, address, sharedSecret)\n\n  if (!sample.success) {\n    await output.consoleError(`Request errors:\\n${formatErrors(sample.userErrors)}`)\n    return\n  }\n\n  if (deliveryMethod === DELIVERY_METHOD.LOCALHOST) {\n    const result = await triggerLocalWebhook(address, sample.samplePayload, sample.headers)\n\n    if (result) {\n      output.success('Localhost delivery sucessful')\n      return\n    }\n\n    await output.consoleError('Localhost delivery failed')\n    return\n  }\n\n  if (sample.samplePayload === JSON.stringify({})) {\n    output.success('Webhook has been enqueued for delivery')\n  }\n}\n\nfunction formatErrors(errors: UserErrors[]): string {\n  try {\n    return errors\n      .map((element) =>\n        JSON.parse(element.message)\n          .map((msg: string) => `  Â· ${msg}`)\n          .join('\\n'),\n      )\n      .join('\\n')\n    // eslint-disable-next-line no-catch-all/no-catch-all\n  } catch (err) {\n    return JSON.stringify(errors)\n  }\n}\n"]}