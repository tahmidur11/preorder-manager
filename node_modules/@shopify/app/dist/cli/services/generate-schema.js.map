{"version":3,"file":"generate-schema.js","sourceRoot":"","sources":["../../../src/cli/services/generate-schema.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,oCAAoC,EAAC,MAAM,kBAAkB,CAAA;AAGrE,OAAO,EAAC,iBAAiB,EAAC,MAAM,8BAA8B,CAAA;AAC9D,OAAO,EACL,wBAAwB,GAGzB,MAAM,mDAAmD,CAAA;AAC1D,OAAO,EAAC,MAAM,EAAC,MAAM,kBAAkB,CAAA;AACvC,OAAO,EAAC,eAAe,EAAC,MAAM,oCAAoC,CAAA;AAClE,OAAO,EAAC,2BAA2B,EAAC,MAAM,+BAA+B,CAAA;AACzE,OAAO,EAAC,qBAAqB,EAAC,MAAM,yCAAyC,CAAA;AAC7E,OAAO,EAAC,UAAU,EAAC,MAAM,6BAA6B,CAAA;AAQtD,MAAM,CAAC,KAAK,UAAU,qBAAqB,CAAC,OAA8B;IACxE,MAAM,EAAC,SAAS,EAAE,GAAG,EAAC,GAAG,OAAO,CAAA;IAChC,MAAM,KAAK,GAAG,MAAM,2BAA2B,EAAE,CAAA;IACjD,MAAM,EAAC,UAAU,EAAE,OAAO,EAAE,IAAI,EAAC,GAAG,SAAS,CAAC,aAAa,CAAA;IAC3D,IAAI,MAAM,GAAG,OAAO,CAAC,MAAM,IAAI,iBAAiB,CAAC,EAAC,GAAG,EAAC,CAAC,CAAC,GAAG,CAAA;IAE3D,IAAI,CAAC,MAAM,EAAE;QACX,IAAI,CAAC,qBAAqB,EAAE,EAAE;YAC5B,MAAM,IAAI,UAAU,CAClB,MAAM,CAAC,OAAO,CAAA,0BAA0B,EACxC,MAAM,CAAC,OAAO,CAAA,6CAA6C,CAC5D,CAAA;SACF;QAED,MAAM,GAAG,CAAC,MAAM,oCAAoC,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC,CAAC,WAAW,CAAC,MAAM,CAAA;KACrF;IAED,MAAM,KAAK,GAAG,wBAAwB,CAAA;IACtC,MAAM,SAAS,GAAsC;QACnD,MAAM;QACN,OAAO;QACP,IAAI;KACL,CAAA;IACD,MAAM,QAAQ,GAAmC,MAAM,eAAe,CAAC,KAAK,EAAE,KAAK,EAAE,SAAS,CAAC,CAAA;IAE/F,IAAI,CAAC,QAAQ,CAAC,UAAU,EAAE;QACxB,MAAM,IAAI,UAAU,CAClB,MAAM,CAAC,OAAO,CAAA,uCAAuC,SAAS,CAAC,eAAe,EAAE,EAChF,MAAM,CAAC,OAAO,CAAA,yDAAyD,CACxE,CAAA;KACF;IAED,OAAO,QAAQ,CAAC,UAAU,CAAA;AAC5B,CAAC","sourcesContent":["import {fetchOrganizationAndFetchOrCreateApp} from './environment.js'\nimport {AppInterface} from '../models/app/app.js'\nimport {FunctionExtension} from '../models/app/extensions.js'\nimport {getAppIdentifiers} from '../models/app/identifiers.js'\nimport {\n  ApiSchemaDefinitionQuery,\n  ApiSchemaDefinitionQuerySchema,\n  ApiSchemaDefinitionQueryVariables,\n} from '../api/graphql/functions/api_schema_definition.js'\nimport {output} from '@shopify/cli-kit'\nimport {partnersRequest} from '@shopify/cli-kit/node/api/partners'\nimport {ensureAuthenticatedPartners} from '@shopify/cli-kit/node/session'\nimport {isTerminalInteractive} from '@shopify/cli-kit/node/environment/local'\nimport {AbortError} from '@shopify/cli-kit/node/error'\n\ninterface GenerateSchemaOptions {\n  app: AppInterface\n  extension: FunctionExtension\n  apiKey?: string\n}\n\nexport async function generateSchemaService(options: GenerateSchemaOptions) {\n  const {extension, app} = options\n  const token = await ensureAuthenticatedPartners()\n  const {apiVersion: version, type} = extension.configuration\n  let apiKey = options.apiKey || getAppIdentifiers({app}).app\n\n  if (!apiKey) {\n    if (!isTerminalInteractive()) {\n      throw new AbortError(\n        output.content`No API key was provided.`,\n        output.content`Provide an API key with the --api-key flag.`,\n      )\n    }\n\n    apiKey = (await fetchOrganizationAndFetchOrCreateApp(app, token)).partnersApp.apiKey\n  }\n\n  const query = ApiSchemaDefinitionQuery\n  const variables: ApiSchemaDefinitionQueryVariables = {\n    apiKey,\n    version,\n    type,\n  }\n  const response: ApiSchemaDefinitionQuerySchema = await partnersRequest(query, token, variables)\n\n  if (!response.definition) {\n    throw new AbortError(\n      output.content`A schema could not be generated for ${extension.localIdentifier}`,\n      output.content`Check that the Function API type and version are valid.`,\n    )\n  }\n\n  return response.definition\n}\n"]}